<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Editor Video M√≥vil Final</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Reset y ajustes para m√≥vil */
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            overscroll-behavior: none; touch-action: none; background-color: #000;
            height: 100dvh; /* Altura din√°mica real del m√≥vil */
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Contenedor principal del canvas */
        .canvas-container-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            overflow: hidden;
            width: 100%;
        }

        /* El video fuente real. 
           TRUCO: Est√° detr√°s del canvas (z-index -1) pero NO tiene 'display:none'.
           Esto es crucial para que el iPhone lo procese. */
        #sourceVideo {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            z-index: -1; 
            pointer-events: none;
            opacity: 0; /* Invisible al ojo, visible al navegador */
        }

        /* Botones de herramientas */
        .tool-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #9ca3af; font-size: 0.7rem; transition: all 0.2s;
        }
        .tool-btn:active { color: #818cf8; transform: scale(0.9); }
        .tool-btn i { font-size: 1.4rem; margin-bottom: 5px; }

        /* Animaci√≥n de grabaci√≥n */
        .rec-dot {
            width: 12px; height: 12px; background-color: #ef4444;
            border-radius: 50%; display: inline-block; margin-right: 8px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="text-white font-['Roboto']">

    <header class="h-14 bg-gray-900 flex justify-between items-center px-4 border-b border-gray-800 shrink-0 relative z-20">
        <div class="font-bold text-lg">Social<span class="text-indigo-500">Editor</span></div>
        
        <div class="flex gap-3">
            <label id="uploadBtn" class="bg-gray-800 border border-gray-700 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 cursor-pointer active:bg-gray-700 transition">
                <i class="fa-solid fa-plus"></i> <span id="btnText">Video</span>
                <input type="file" id="videoInput" class="hidden" accept="video/mp4,video/webm">
            </label>

            <button id="saveBtn" onclick="startRecordingProcess()" class="bg-indigo-600 active:bg-indigo-700 px-4 py-1.5 rounded-full text-xs font-bold hidden flex items-center gap-2 transition shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-download"></i> Guardar Video
            </button>
        </div>
    </header>

    <main class="canvas-container-wrapper">
        
        <div id="welcomeMsg" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center z-10 bg-gray-900/90 backdrop-blur-sm">
            <i class="fa-solid fa-clapperboard text-5xl text-indigo-500 mb-4 animate-bounce"></i>
            <h2 class="text-xl font-bold mb-2">Crea tu Video Viral</h2>
            <p class="text-gray-400 text-sm mb-6 max-w-[250px]">Sube un video corto (5s a 40s) para empezar a editar.</p>
            <div class="text-xs text-indigo-400 font-medium">‚Üë Toca "Video" arriba</div>
        </div>

        <canvas id="c"></canvas>
        
        <video id="sourceVideo" playsinline webkit-playsinline crossorigin="anonymous"></video>
    </main>

    <footer id="toolsFooter" class="h-20 bg-gray-900 border-t border-gray-800 grid grid-cols-4 shrink-0 hidden pb-[env(safe-area-inset-bottom)]">
        <button onclick="addText()" class="tool-btn"><i class="fa-solid fa-font"></i> Texto</button>
        <button onclick="addTemplate()" class="tool-btn"><i class="fa-solid fa-wand-magic-sparkles"></i> Plantilla</button>
        <button onclick="addEmoji()" class="tool-btn"><i class="fa-regular fa-face-smile-wink"></i> Emoji</button>
        <button onclick="deleteActive()" class="tool-btn text-red-400"><i class="fa-solid fa-trash-can"></i> Borrar</button>
    </footer>

    <div id="editPanel" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-5 rounded-t-[2rem] transform translate-y-full transition-transform duration-300 z-40 shadow-[0_-10px_40px_rgba(0,0,0,0.6)] pb-10">
        <div class="flex justify-between items-center mb-5">
            <span class="font-bold text-xs text-gray-400 uppercase tracking-widest pl-2">Estilo</span>
            <button onclick="closeEditPanel()" class="w-9 h-9 bg-gray-700/50 rounded-full flex items-center justify-center active:bg-gray-600 transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="mb-6 pl-1">
             <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar snap-x">
                <div onclick="setColor('#ffffff')" class="w-11 h-11 rounded-full bg-white border-2 border-gray-700 shadow-sm shrink-0 snap-start relative"><div class="absolute inset-0 rounded-full shadow-inner"></div></div>
                <div onclick="setColor('#000000')" class="w-11 h-11 rounded-full bg-black border-2 border-gray-700 shadow-sm shrink-0 snap-start relative"><div class="absolute inset-0 rounded-full shadow-inner"></div></div>
                <div onclick="setColor('#F59E0B')" class="w-11 h-11 rounded-full bg-amber-500 shadow-sm shrink-0 snap-start"></div>
                <div onclick="setColor('#EF4444')" class="w-11 h-11 rounded-full bg-red-500 shadow-sm shrink-0 snap-start"></div>
                <div onclick="setColor('#3B82F6')" class="w-11 h-11 rounded-full bg-blue-500 shadow-sm shrink-0 snap-start"></div>
                <div onclick="setColor('#10B981')" class="w-11 h-11 rounded-full bg-emerald-500 shadow-sm shrink-0 snap-start"></div>
            </div>
        </div>
        <div class="bg-gray-900/50 rounded-2xl p-4 flex items-center gap-4 border border-gray-700/50 mx-1">
            <i class="fa-solid fa-text-height text-gray-400 text-sm"></i>
            <input type="range" id="sizeSlider" min="0.5" max="2.0" step="0.1" value="1" class="w-full h-1.5 bg-gray-700 rounded-full appearance-none accent-indigo-500">
            <i class="fa-solid fa-text-height text-white text-xl"></i>
        </div>
    </div>

    <div id="recordingOverlay" class="fixed inset-0 bg-black/95 z-[100] hidden flex-col items-center justify-start pt-20 text-center px-6 backdrop-blur-md">
        <div class="bg-red-500/20 text-red-500 px-4 py-2 rounded-full font-bold flex items-center mb-8 animate-pulse">
            <span class="rec-dot"></span> GRABANDO EN VIVO
        </div>
        <h3 class="text-2xl font-bold text-white mb-4">Mira tu video final...</h3>
        <p class="text-sm text-gray-300 max-w-xs mx-auto leading-relaxed">
            Por favor, <strong class="text-white">no cierres esta pantalla</strong> ni cambies de pesta√±a. El video se descargar√° autom√°ticamente al terminar la reproducci√≥n.
        </p>
        <div class="w-64 h-1.5 bg-gray-800 rounded-full mt-10 overflow-hidden">
            <div id="recProgress" class="h-full bg-red-500 w-0 transition-all duration-100 ease-linear"></div>
        </div>
    </div>

    <script>
        // --- INICIALIZACI√ìN ---
        // Configuraci√≥n crucial de FabricJS para video
        fabric.Object.prototype.transparentCorners = false;
        fabric.Object.prototype.cornerColor = '#6366f1';
        fabric.Object.prototype.cornerStyle = 'circle';

        const canvas = new fabric.Canvas('c', { 
            selection: false, // Mejor para m√≥vil
            preserveObjectStacking: true // Mantiene el orden de capas
        });
        
        const videoEl = document.getElementById('sourceVideo');
        const editPanel = document.getElementById('editPanel');
        let fabricVideoObj; 
        let isRecordingMode = false;
        let audioCtx; // Contexto de audio global

        // Ajustar canvas al tama√±o de la ventana
        const resizeCanvas = () => {
            const wrapper = document.querySelector('.canvas-container-wrapper');
            canvas.setWidth(wrapper.clientWidth);
            canvas.setHeight(wrapper.clientHeight);
            if(fabricVideoObj) scaleVideoToCanvas();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // Primer ajuste

        // --- 1. CARGA DE VIDEO (Validaci√≥n y Setup) ---
        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Resetear UI por si cargan otro
            resetUI();

            const url = URL.createObjectURL(file);
            videoEl.src = url;
            // Muteado inicial obligatorio para que los navegadores permitan el autoplay
            videoEl.muted = true; 

            videoEl.onloadedmetadata = function() {
                // Validaci√≥n de duraci√≥n (requisito del cliente)
                if (videoEl.duration < 5) { alert("‚ö†Ô∏è Video muy corto. M√≠nimo 5 segundos."); return; }
                if (videoEl.duration > 40) { alert("‚ö†Ô∏è Video muy largo. M√°ximo 40 segundos."); return; }

                // Activar interfaz de edici√≥n
                document.getElementById('welcomeMsg').classList.add('hidden');
                document.getElementById('toolsFooter').classList.remove('hidden');
                document.getElementById('toolsFooter').classList.add('grid');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('btnText').innerText = "Cambiar";
                
                setupCanvasWithVideo();
            };
        });

        function setupCanvasWithVideo() {
            // Creamos el objeto de video para Fabric
            fabricVideoObj = new fabric.Image(videoEl, {
                left: 0, top: 0,
                selectable: false, evented: false, // No se puede mover
                objectCaching: false // ¬°CRUCIAL! Obliga a redibujar cada frame
            });

            canvas.clear();
            canvas.add(fabricVideoObj);
            canvas.sendToBack(fabricVideoObj);
            
            scaleVideoToCanvas();

            // Reproducir en bucle para editar
            videoEl.loop = true;
            videoEl.play().catch(e => console.error("Error autoplay:", e));
            
            // Iniciar el Bucle de Renderizado (El coraz√≥n del sistema)
            renderLoop();
        }

        function scaleVideoToCanvas() {
             if(!fabricVideoObj || !videoEl.videoWidth) return;
             
             const canvasW = canvas.getWidth();
             const canvasH = canvas.getHeight();
             const videoRatio = videoEl.videoWidth / videoEl.videoHeight;
             const canvasRatio = canvasW / canvasH;

             // L√≥gica "Contain" (ver todo el video sin cortar)
             let scaleFactor;
             if (videoRatio > canvasRatio) {
                 scaleFactor = canvasW / videoEl.videoWidth; // Ajustar al ancho
             } else {
                 scaleFactor = canvasH / videoEl.videoHeight; // Ajustar al alto
             }

             fabricVideoObj.set({
                 scaleX: scaleFactor,
                 scaleY: scaleFactor
             });
             canvas.centerObject(fabricVideoObj);
             canvas.renderAll();
        }

        // Bucle que redibuja el canvas constantemente
        function renderLoop() {
            if (videoEl.readyState >= 2 && !isRecordingMode) {
                canvas.renderAll();
            }
            requestAnimationFrame(renderLoop);
        }


        // --- 2. HERRAMIENTAS (Texto, Emojis) ---
        function addText() {
            const t = new fabric.IText('Toca 2 veces', {
                left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center',
                fontFamily: 'Montserrat', fontSize: 32, fill: '#fff', fontWeight: 'bold',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.6)', blur: 10, offsetX: 0, offsetY: 4 })
            });
            canvas.add(t); canvas.setActiveObject(t);
        }

        function addTemplate() {
            const rect = new fabric.Rect({
                fill: '#ffffff', width: 240, height: 55, rx: 27.5, ry: 27.5,
                originX: 'center', originY: 'center', shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.3)', blur: 15, offsetY: 5 })
            });
            const t = new fabric.IText('TU TEXTO', {
                fontFamily: 'Montserrat', fontSize: 22, fill: '#000',
                originX: 'center', originY: 'center', fontWeight: '800', top: 1
            });
            const g = new fabric.Group([rect, t], { left: canvas.width/2, top: canvas.height/2 });
            canvas.add(g); canvas.setActiveObject(g);
        }

        function addEmoji() {
            const e = new fabric.IText('ü§©', {
                fontSize: 65, left: canvas.width/2, top: canvas.height/2, originX:'center', originY:'center'
            });
            canvas.add(e); canvas.setActiveObject(e);
        }

        function deleteActive() {
            const a = canvas.getActiveObject(); if(a) canvas.remove(a); closeEditPanel();
        }

        // --- 3. PANEL DE EDICI√ìN (UX M√≥vil) ---
        canvas.on('selection:created', openPanel);
        canvas.on('selection:updated', openPanel);
        canvas.on('selection:cleared', closeEditPanel);

        function openPanel() { editPanel.classList.remove('translate-y-full'); }
        function closeEditPanel() { 
            editPanel.classList.add('translate-y-full'); 
            canvas.discardActiveObject(); canvas.renderAll();
        }

        function setColor(hex) {
            const act = canvas.getActiveObject(); if(!act) return;
            if(act.type === 'group') {
                act.getObjects().forEach(o => {
                    if(o.type === 'rect') o.set('fill', hex);
                    if(o.type === 'i-text') o.set('fill', hex === '#ffffff' ? '#000000' : '#ffffff');
                });
            } else { act.set('fill', hex); }
            canvas.renderAll();
        }
        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            const act = canvas.getActiveObject();
            if(act) { act.scale(parseFloat(e.target.value)); canvas.renderAll(); }
        });


        // --- 4. EL FIX DEFINITIVO: GRABACI√ìN "EN VIVO" ---
        
        // Inicializar audio con interacci√≥n del usuario (necesario en iOS)
        document.body.addEventListener('click', () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

        async function startRecordingProcess() {
            // 1. Bloquear UI y mostrar Overlay
            isRecordingMode = true;
            document.getElementById('recordingOverlay').classList.remove('hidden');
            document.getElementById('recordingOverlay').classList.add('flex');
            closeEditPanel();

            // 2. Preparar el video fuente
            videoEl.pause();
            videoEl.currentTime = 0;
            videoEl.loop = false; // Importante: que se detenga al final
            // ¬°AQU√ç EST√Å LA CLAVE! Activamos el sonido.
            videoEl.muted = false; 

            // 3. Configurar la captura (Video + Audio)
            const canvasStream = canvas.getElement().captureStream(30); // 30 FPS

            // Conectar el audio del video al grabador
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            try {
                // Intentamos conectar el nodo de audio. Si ya existe, fallar√°, lo ignoramos.
                const source = audioCtx.createMediaElementSource(videoEl);
                source.connect(dest);
                // Conectar tambi√©n a la salida (parlantes) para que el usuario lo escuche
                source.connect(audioCtx.destination); 
            } catch (e) { /* Ya estaba conectado */ }

            // Mezclar video del canvas y audio del elemento video
            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            // 4. Iniciar la grabadora
            const chunks = [];
            // Preferir c√≥decs modernos (VP9/Opus), fallback a est√°ndar
            let options = { mimeType: 'video/webm;codecs=vp9,opus' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
            
            const recorder = new MediaRecorder(combinedStream, options);

            recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            
            recorder.onstop = () => {
                finish Recording(chunks);
            };

            // 5. ¬°ACCI√ìN! Iniciar todo sincronizado
            recorder.start();
            
            // Bucle de renderizado manual durante la grabaci√≥n
            // Forzamos a Fabric a dibujar en cada actualizaci√≥n de tiempo del video
            const manualRender = () => canvas.renderAll();
            videoEl.addEventListener('timeupdate', manualRender);

            try {
                // Reproducir el video (el usuario lo ver√° y escuchar√°)
                await videoEl.play();
            } catch (err) {
                alert("Error al reproducir. Toca la pantalla e intenta de nuevo.");
                resetUI();
                return;
            }

            // Barra de progreso visual
            const progressInterval = setInterval(() => {
                const pct = (videoEl.currentTime / videoEl.duration) * 100;
                document.getElementById('recProgress').style.width = `${pct}%`;
                if (videoEl.ended) clearInterval(progressInterval);
            }, 100);

            // Cuando el video termina, detenemos la grabaci√≥n
            videoEl.onended = () => {
                recorder.stop();
                videoEl.removeEventListener('timeupdate', manualRender);
            };
        }

        function finishRecording(chunks) {
            // Crear y descargar el archivo
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Nombre de archivo con fecha
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
            a.download = `video-social-${timestamp}.webm`;
            document.body.appendChild(a);
            a.click();
            
            // Limpieza y restauraci√≥n de UI
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                resetUI();
            }, 1000);
        }

        function resetUI() {
            // Volver al estado de edici√≥n normal
            document.getElementById('recordingOverlay').classList.add('hidden');
            document.getElementById('recordingOverlay').classList.remove('flex');
            document.getElementById('recProgress').style.width = '0%';
            isRecordingMode = false;
            videoEl.muted = true;
            videoEl.loop = true;
            videoEl.currentTime = 0;
            videoEl.play().catch(()=>{});
        }
    </script>
</body>
</html>

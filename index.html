<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editor Pro: Imagen a Video</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Un poco de estilo extra para el canvas */
        .canvas-container { margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <header class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
        <h1 class="text-xl font-bold text-purple-400">Studio <span class="text-white">Editor</span></h1>
        <button onclick="exportVideo()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2 transition">
            <span>●</span> Grabar Video (5s)
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-64 bg-gray-800 p-4 flex flex-col gap-4 border-r border-gray-700">
            
            <div class="p-4 border-2 border-dashed border-gray-600 rounded-lg text-center hover:border-purple-500 transition cursor-pointer relative">
                <p class="text-sm text-gray-400">Sube tu Imagen</p>
                <input type="file" id="imgLoader" class="opacity-0 absolute inset-0 cursor-pointer" accept="image/*">
            </div>

            <button onclick="addText()" class="bg-gray-700 hover:bg-gray-600 p-3 rounded text-left">
                Agrega Texto
            </button>
            
            <div class="mt-auto text-xs text-gray-500">
                Selecciona un objeto para editarlo. Usa "Supr" para borrar.
            </div>
        </div>

        <div class="flex-1 bg-gray-900 flex justify-center items-center relative p-10 overflow-auto">
            <canvas id="c" width="1080" height="1080"></canvas> </div>

    </div>

    <script>
        // 1. Configuración del Lienzo (Canvas)
        const canvas = new fabric.Canvas('c', {
            backgroundColor: '#1a1a1a', // Fondo oscuro por defecto
            width: 500,  // Escalado visualmente para la demo
            height: 500
        });

        // Evento: Subir Imagen
        document.getElementById('imgLoader').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function() {
                    const image = new fabric.Image(imgObj);
                    
                    // Ajustar imagen para que quepa bien
                    image.scaleToWidth(300);
                    
                    canvas.add(image);
                    canvas.centerObject(image);
                    canvas.setActiveObject(image);
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // Función: Agregar Texto
        function addText() {
            const text = new fabric.Textbox('Tu Texto Aquí', {
                left: 50,
                top: 50,
                width: 200,
                fontSize: 30,
                fontFamily: 'Arial',
                fontWeight: 'bold',
                fill: '#ffffff',
                textAlign: 'center',
                borderColor: '#a855f7',
                cornerColor: '#a855f7',
                cornerSize: 10,
                transparentCorners: false
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // Eliminar con tecla Supr/Delete
        document.addEventListener('keydown', function(e) {
            if(e.key === "Delete" || e.key === "Backspace") {
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects.length) {
                    canvas.discardActiveObject();
                    activeObjects.forEach(function(object) {
                        canvas.remove(object);
                    });
                }
            }
        });

        // --- LÓGICA DE VIDEO (La parte mágica) ---
        
        async function exportVideo() {
            const btn = document.querySelector('button[onclick="exportVideo()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Grabando...";
            btn.classList.add('animate-pulse');

            // 1. Capturar el stream del canvas
            const canvasElement = document.getElementById('c');
            const stream = canvasElement.captureStream(30); // 30 FPS
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9' // Formato web moderno
            });

            const chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

            mediaRecorder.onstop = (e) => {
                // Crear el archivo de video
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // Descargar
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mi-video-promo.webm';
                a.click();
                
                // Resetear botón
                btn.innerHTML = originalText;
                btn.classList.remove('animate-pulse');
            };

            // 2. Iniciar grabación
            mediaRecorder.start();

            // 3. Simular una animación simple para que el video no sea estático
            // (Aquí es donde programarías movimientos reales)
            const objects = canvas.getObjects();
            
            let duration = 0;
            const totalDuration = 5000; // 5 segundos
            
            function animate() {
                if (duration < totalDuration) {
                    // Ejemplo: Rotar ligeramente todo o hacer zoom
                    // En un caso real, usarías GSAP o animaciones de Fabric
                    objects.forEach(obj => {
                        // Animación sutil de "respiración" o movimiento
                        if(obj.type === 'image') {
                            obj.rotate((obj.angle || 0) + 0.2); 
                        }
                    });
                    canvas.renderAll();
                    duration += 16; // ~60fps loop
                    requestAnimationFrame(animate);
                } else {
                    mediaRecorder.stop(); // Parar grabación a los 5s
                }
            }
            animate();
        }

    </script>
</body>
</html>
